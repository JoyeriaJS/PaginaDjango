{% extends "catalog/base_admin.html" %}
{% block title %}Productos — Panel{% endblock %}

{% block content %}

<!-- Encabezado -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="fw-bold m-0" style="font-size:1.8rem;">Productos</h1>
  <a href="{% url 'catalog:product_create' %}" class="btn btn-primary px-4 py-2" style="border-radius:12px;">
    + Nuevo producto
  </a>
</div>

<!-- FILTROS AVANZADOS -->
<div class="card shadow-sm border-0 mb-4" style="border-radius:16px;">
  <div class="card-body">

    <form class="row g-3" method="get">

      <!-- Buscador -->
      <div class="col-md-4">
        <label class="form-label fw-semibold">Buscar</label>
        <input name="q" value="{{ q|default:'' }}" class="form-control" placeholder="Nombre, SKU o descripción">
      </div>

      <!-- Categoría -->
      <div class="col-md-3">
        <label class="form-label fw-semibold">Categoría</label>
        <select name="cat" class="form-select">
          <option value="">Todas las categorías</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if cat == c.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Activo / inactivo -->
      <div class="col-md-3">
        <label class="form-label fw-semibold">Estado</label>
        <select name="active" class="form-select">
          <option value="">Todos</option>
          <option value="1" {% if active == "1" %}selected{% endif %}>Activos</option>
          <option value="0" {% if active == "0" %}selected{% endif %}>Inactivos</option>
        </select>
      </div>

      <!-- Botón Filtrar -->
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100 py-2" style="border-radius:12px;">Filtrar</button>
      </div>

    </form>

  </div>
</div>

<!-- Info diagnóstica -->
{% if total_count is not None and shown_count is not None %}
  <div class="alert alert-info d-flex justify-content-between">
    <span>Total en BD: <strong>{{ total_count }}</strong></span>
    <span>Mostrados ahora: <strong>{{ shown_count }}</strong></span>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'catalog:product_list' %}">
      Limpiar filtros
    </a>
  </div>
{% endif %}

<!-- TABLA PRINCIPAL PREMIUM -->
<div class="table-responsive">
  <table class="table align-middle table-hover">

    <thead class="table-light" style="border-bottom:2px solid #e6e6e6;">
      <tr>
        <th style="width:75px;">Img</th>
        <th>Nombre</th>
        <th>Categoría</th>
        <th>SKU</th>
        <th>Precio</th>
        <th>Stock</th>
        <th>Activo</th>
        <th class="text-end">Acciones</th>
      </tr>
    </thead>

    <tbody>
      {% for p in products %}
      <tr>

        <!-- Imagen -->
        <td>
          {% with img=p.images.first %}
            {% if img %}
              <img src="{{ img.image.url }}" class="rounded" 
                   style="width:60px;height:60px;object-fit:cover;box-shadow:0 2px 6px rgba(0,0,0,.08);">
            {% else %}
              <div class="d-flex align-items-center justify-content-center bg-light text-muted"
                   style="width:60px;height:60px;border-radius:8px;border:1px solid #ddd;">—</div>
            {% endif %}
          {% endwith %}
        </td>

        <!-- Nombre -->
        <td class="fw-semibold">{{ p.name }}</td>

        <!-- Categoría -->
        <td class="text-muted">{{ p.category.name }}</td>

        <!-- SKU -->
        <td class="text-muted small">{{ p.sku|default:"—" }}</td>

        <!-- Precio -->
        <td class="fw-semibold">${{ p.price }}</td>

        <!-- Stock -->
        <td>{{ p.stock }}</td>

        <!-- Estado -->
        <td>
          {% if p.is_active %}
            <span class="badge bg-success px-3 py-2" style="border-radius:10px;">Activo</span>
          {% else %}
            <span class="badge bg-secondary px-3 py-2" style="border-radius:10px;">Inactivo</span>
          {% endif %}
        </td>

        <!-- Acciones -->
        <td class="text-end">

          <a class="btn btn-sm btn-outline-info me-1" style="border-radius:10px;"
             href="{% url 'catalog:product_images' p.pk %}">
            Imágenes
          </a>

          <a class="btn btn-sm btn-outline-primary me-1" style="border-radius:10px;"
             href="{% url 'catalog:product_edit' p.pk %}">
            Editar
          </a>

          <form action="{% url 'catalog:product_delete' p.pk %}" method="post" class="d-inline">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger" style="border-radius:10px;"
                    onclick="return confirm('¿Eliminar producto?')">
              Eliminar
            </button>
          </form>

        </td>

      </tr>
      {% empty %}
      <tr>
        <td colspan="8" class="text-center text-muted py-5">
          No se encontraron productos.
        </td>
      </tr>
      {% endfor %}
    </tbody>

  </table>
</div>

<!-- PAGINACIÓN -->
{% if products.has_other_pages %}
<nav aria-label="Paginación de productos" class="mt-3">
  <ul class="pagination justify-content-center">
    {% if products.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ products.previous_page_number }}&q={{ q }}&cat={{ cat }}&active={{ active }}">«</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">«</span></li>
    {% endif %}

    <li class="page-item disabled">
      <span class="page-link">Página {{ products.number }} de {{ products.paginator.num_pages }}</span>
    </li>

    {% if products.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ products.next_page_number }}&q={{ q }}&cat={{ cat }}&active={{ active }}">»</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">»</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% endblock %}
