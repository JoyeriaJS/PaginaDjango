{% load i18n %}
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top shadow-sm">
  <div class="container">

    <!-- Logo -->
    <a class="navbar-brand fw-bold" href="/">Casteable</a>

    <!-- BotÃ³n mÃ³vil -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#mainNav" aria-controls="mainNav"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- ========================================================= -->
    <!-- NAV COLLAPSE â€” ORDENADO Y OPTIMIZADO PARA MOBILE         -->
    <!-- ========================================================= -->
    <div class="collapse navbar-collapse" id="mainNav">

      <!-- ðŸ” Buscador (siempre primero en mobile) -->
      <form class="d-flex me-auto my-3" method="get" action="{% url 'core:search' %}">
        <input class="form-control" type="search" name="q"
               placeholder="Buscar productosâ€¦"
               aria-label="Buscar" value="{{ request.GET.q }}">
      </form>

      <!-- ðŸ“‚ MenÃº dinÃ¡mico -->
      <ul class="navbar-nav me-auto mb-3">
        {% for it in main_menu %}
          {% if it.children %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="{{ it.url }}" data-bs-toggle="dropdown">
                {{ it.title }}
              </a>
              <ul class="dropdown-menu">
                {% for ch in it.children %}
                  <li><a class="dropdown-item" href="{{ ch.url }}">{{ ch.title }}</a></li>
                {% endfor %}
              </ul>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ it.url }}">{{ it.title }}</a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>

      <!-- ðŸ›’ Carrito destacado en mobile -->
      <div class="mb-3">
        <a href="{% url 'core:cart_detail' %}"
           class="btn btn-elegant w-100 d-flex align-items-center justify-content-between">
          <span><i class="bi bi-bag"></i> Carrito</span>

          {% if cart_count %}
            <span class="badge bg-primary text-white">{{ cart_count }}</span>
          {% endif %}
        </a>
      </div>

      <!-- ðŸ‘¤ MenÃº de cuenta -->
      {% if request.user.is_authenticated %}
        <div class="dropdown mb-3 w-100">
          <button class="btn btn-elegant w-100 dropdown-toggle" data-bs-toggle="dropdown">
            Mi Cuenta
          </button>

          <ul class="dropdown-menu w-100 shadow-sm">

            <li><a class="dropdown-item" href="{% url 'accounts:dashboard' %}">Panel</a></li>
            <li><a class="dropdown-item" href="{% url 'accounts:profile' %}">Perfil</a></li>
            <li><a class="dropdown-item" href="{% url 'accounts:address_list' %}">Direcciones</a></li>
            <li><a class="dropdown-item" href="{% url 'accounts:orders_list' %}">Historial de compras</a></li>

            <li><hr class="dropdown-divider"></li>

            <li><a class="dropdown-item text-danger" href="{% url 'core:logout' %}">
              Cerrar sesiÃ³n
            </a></li>
          </ul>
        </div>

      {% else %}
        <a class="btn btn-elegant text-white w-100 mb-2" href="{% url 'core:login' %}">Ingresar</a>
        <a class="btn btn-elegant text-white w-100 mb-3" href="{% url 'core:register' %}">Crear cuenta</a>
      {% endif %}

      <!-- ðŸŒŽ Idioma + ðŸŒ™ Modo oscuro -->
      <div class="d-flex justify-content-between align-items-center gap-3 mt-2">

        <select id="lang-switcher"
                class="form-select form-select-sm"
                style="max-width: 110px"
                onchange="window.changeLang && window.changeLang(this.value)">
          <option value="es" {% if request.LANGUAGE_CODE == 'es' %}selected{% endif %}>ES</option>
          <option value="en" {% if request.LANGUAGE_CODE == 'en' %}selected{% endif %}>EN</option>
        </select>

        <button id="themeToggle"
                class="btn btn-sm btn-outline-secondary rounded-pill px-3">
          ðŸŒ™
        </button>
      </div>

    </div>
  </div>
</nav>
