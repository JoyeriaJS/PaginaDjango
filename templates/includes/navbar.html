{% load i18n %}
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top shadow-sm">
  <div class="container">

    <!-- LOGO -->
    <a class="navbar-brand fw-bold" href="/">Casteable</a>

    <!-- BOTÃ“N MÃ“VIL -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#mainNav" aria-controls="mainNav"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- CONTENIDO -->
    <div class="collapse navbar-collapse" id="mainNav">

      <!-- BUSCADOR + AUTOCOMPLETE -->
      <form class="d-flex me-auto ms-lg-3 my-2 my-lg-0 position-relative"
            method="get" action="{% url 'core:search' %}">
        
        <input class="form-control" type="search" name="q" id="searchInput"
              placeholder="Buscar productosâ€¦" autocomplete="off"
              aria-label="Buscar" value="{{ request.GET.q }}">

        <!-- RESULTADOS -->
        <div id="searchResults"
             class="position-absolute bg-white shadow rounded w-100"
             style="top: 110%; left: 0; z-index: 1000; display:none;"></div>
      </form>

      <!-- ============================= -->
      <!-- MENÃšS (CMS + CATEGORÃAS) -->
      <!-- ============================= -->
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

        <!-- MENÃš DINÃMICO CMS -->
        {% for it in main_menu %}
          {% if it.children %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="{{ it.url }}" data-bs-toggle="dropdown">
                {{ it.title }}
              </a>
              <ul class="dropdown-menu">
                {% for ch in it.children %}
                  <li><a class="dropdown-item" href="{{ ch.url }}">{{ ch.title }}</a></li>
                {% endfor %}
              </ul>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ it.url }}">{{ it.title }}</a>
            </li>
          {% endif %}
        {% endfor %}

        <!-- MENÃš DE CATEGORÃAS -->
        {% if nav_categories %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
            CategorÃ­as
          </a>
          <ul class="dropdown-menu">

            <!-- Ver todas -->
            <li>
              <a class="dropdown-item fw-bold text-primary" href="{% url 'core:category_all' %}">
                Todas las CategorÃ­as
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>

            <!-- Listado de categorÃ­as -->
            {% for c in nav_categories %}
              <li>
                <a class="dropdown-item" href="{% url 'core:category_list' c.pk %}">
                  {{ c.name }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </li>
        {% endif %}
      </ul>

      <!-- SELECTOR DE IDIOMA -->
      <select id="lang-switcher"
              class="form-select form-select-sm me-3"
              style="width:auto"
              onchange="window.changeLang && window.changeLang(this.value)">
        <option value="es" {% if request.LANGUAGE_CODE == 'es' %}selected{% endif %}>ES</option>
        <option value="en" {% if request.LANGUAGE_CODE == 'en' %}selected{% endif %}>EN</option>
      </select>

      <!-- DARK MODE -->
      <button id="themeToggle"
              class="btn btn-sm btn-outline-secondary rounded-pill px-3 me-2">
        ðŸŒ™
      </button>

      <!-- MENÃš DE CUENTA -->
      {% if request.user.is_authenticated %}
        <div class="nav-item dropdown">
          <a class="btn btn-elegant dropdown-toggle text-white rounded-pill px-3"
             href="#" data-bs-toggle="dropdown">
            Mi Cuenta
          </a>

      <!-- CARRITO -->
      <a href="{% url 'core:cart_detail' %}"
         class="btn btn-elegant d-flex align-items-center gap-2 position-relative me-3">
        <span class="bi bi-bag"></span>
        <span>Carrito</span>

        {% if cart_count %}
          <span class="badge bg-primary text-white position-absolute"
                style="top:-6px; right:-6px; font-size:0.65rem;">
            {{ cart_count }}
          </span>
        {% endif %}
      </a>

      

          <ul class="dropdown-menu dropdown-menu-end shadow-sm">
            <li><a class="dropdown-item" href="{% url 'accounts:dashboard' %}">Panel</a></li>
            <li><a class="dropdown-item" href="{% url 'accounts:profile' %}">Perfil</a></li>
            <li><a class="dropdown-item" href="{% url 'accounts:address_list' %}">Direcciones</a></li>
            <li><a class="dropdown-item" href="{% url 'accounts:orders_list' %}">Historial de compras</a></li>

            <li><hr class="dropdown-divider"></li>

            <li><a class="dropdown-item text-danger" href="{% url 'core:logout' %}">
              Cerrar sesiÃ³n
            </a></li>
          </ul>
        </div>
      {% else %}
        <a class="btn btn-elegant text-white" href="{% url 'core:login' %}">Ingresar</a>
        <a class="btn btn-elegant text-white" href="{% url 'core:register' %}">Crear cuenta</a>
      {% endif %}

    </div>
  </div>

  <!-- FORMULARIO OCULTO (i18n) -->
  <form id="lang-form" method="post" action="{% url 'set_language' %}" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="language" id="lang-input">
  </form>

  <!-- ================================= -->
  <!-- SCRIPT â€” AUTOCOMPLETADO BUSCADOR -->
  <!-- ================================= -->
  <script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("searchInput");
    const box = document.getElementById("searchResults");

    let timeout = null;

    input.addEventListener("input", function () {
        const q = this.value.trim();
        clearTimeout(timeout);

        if (!q) {
            box.style.display = "none";
            return;
        }

        timeout = setTimeout(() => {
            fetch(`/buscar/ajax/?q=${encodeURIComponent(q)}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.results.length) {
                        box.innerHTML = `<div class="p-2 text-muted small">Sin resultadosâ€¦</div>`;
                        box.style.display = "block";
                        return;
                    }

                    box.innerHTML = data.results.map(p => `
                        <a href="${p.url}" class="d-flex align-items-center p-2 text-decoration-none text-dark border-bottom">
                            <img src="${p.image || '/static/img/no-image.jpg'}"
                                 style="width:45px; height:45px; object-fit:cover;"
                                 class="rounded me-2">
                            <div>
                                <div class="fw-semibold">${p.name}</div>
                                <div class="text-muted small">${p.price}</div>
                            </div>
                        </a>
                    `).join("");

                    box.style.display = "block";
                });
        }, 250);
    });

    document.addEventListener("click", (e) => {
        if (!box.contains(e.target) && e.target !== input) {
            box.style.display = "none";
        }
    });
});
  </script>

</nav>
