{% load i18n %}
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top shadow-sm">
  <div class="container">

    <!-- Logo -->
    <a class="navbar-brand fw-bold" href="/">Casteable</a>

    <!-- BotÃ³n mÃ³vil -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#mainNav" aria-controls="mainNav"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">

      <!-- Buscador -->
      <form class="d-flex me-auto ms-lg-3 my-2 my-lg-0" method="get" action="{% url 'core:search' %}">
        <input class="form-control" type="search" name="q"
               placeholder="{% trans 'Buscar productosâ€¦' %}"
               aria-label="Buscar" value="{{ request.GET.q }}">
      </form>

      <!-- MenÃº dinÃ¡mico -->
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        {% for it in main_menu %}
          {% if it.children %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="{{ it.url }}" data-bs-toggle="dropdown">
                {{ it.title }}
              </a>
              <ul class="dropdown-menu">
                {% for ch in it.children %}
                  <li><a class="dropdown-item" href="{{ ch.url }}">{{ ch.title }}</a></li>
                {% endfor %}
              </ul>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ it.url }}">{{ it.title }}</a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>

      <!-- Selector de idioma -->
      <select id="lang-switcher"
              class="form-select form-select-sm me-3"
              style="width:auto"
              onchange="window.changeLang && window.changeLang(this.value)">
        <option value="es" {% if request.LANGUAGE_CODE == 'es' %}selected{% endif %}>ES</option>
        <option value="en" {% if request.LANGUAGE_CODE == 'en' %}selected{% endif %}>EN</option>
      </select>

      <!-- Dark Mode -->
      <button id="themeToggle"
              class="btn btn-sm btn-outline-secondary rounded-pill px-3 me-2">
        ğŸŒ™
      </button>

      <!-- Carrito -->
      <a href="{% url 'core:cart_detail' %}"
         class="btn btn-elegant d-flex align-items-center gap-2 position-relative me-3">
        <span class="bi bi-bag"></span>
        <span>{% trans "Carrito" %}</span>

        {% if cart_count %}
          <span class="badge bg-primary text-white position-absolute"
                style="top:-6px; right:-6px; font-size:0.65rem;">
            {{ cart_count }}
          </span>
        {% endif %}
      </a>

      <!-- MENÃš DE CUENTA -->
      {% if request.user.is_authenticated %}
        <div class="nav-item dropdown">
          <a class="btn btn-elegant dropdown-toggle text-white rounded-pill px-3"
             href="#" role="button" data-bs-toggle="dropdown">
            {% trans "Mi Cuenta" %}
          </a>

          <ul class="dropdown-menu dropdown-menu-end shadow-sm">

            <li><a class="dropdown-item" href="{% url 'accounts:dashboard' %}">
              {% trans "Panel" %}
            </a></li>

            <li><a class="dropdown-item" href="{% url 'accounts:profile' %}">
              {% trans "Perfil" %}
            </a></li>

            <li><a class="dropdown-item" href="{% url 'accounts:address_list' %}">
              {% trans "Direcciones" %}
            </a></li>

            <li><a class="dropdown-item" href="{% url 'accounts:orders_list' %}">
              {% trans "Historial de compras" %}
            </a></li>

            <li><hr class="dropdown-divider"></li>

            <li><a class="dropdown-item text-danger" href="{% url 'core:logout' %}">
              {% trans "Cerrar sesiÃ³n" %}
            </a></li>
          </ul>
        </div>

      {% else %}
        <a class="btn btn-elegant text-white" href="{% url 'core:login' %}">
          {% trans "Ingresar" %}
        </a>
        <a class="btn btn-elegant text-white" href="{% url 'core:register' %}">
          {% trans "Crear cuenta" %}
        </a>
      {% endif %}

    </div>
  </div>

  <!-- FORM OCULTO PARA i18n -->
  <form id="lang-form" method="post" action="{% url 'set_language' %}" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="language" id="lang-input">
  </form>

</nav>
