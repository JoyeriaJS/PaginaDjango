{% load i18n %}
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">Casteable</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarsDefault" aria-controls="navbarsDefault"
            aria-expanded="false" aria-label="{% trans 'Alternar navegaci√≥n' %}">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsDefault">

      {# --- Buscador --- #}
      <form class="d-flex me-auto ms-lg-3 my-2 my-lg-0" role="search"
            method="get" action="{% url 'core:search' %}">
        <input class="form-control" type="search"
               placeholder="{% trans 'Buscar productos‚Ä¶' %}"
               aria-label="{% trans 'Buscar' %}"
               name="q" value="{{ request.GET.q }}">
      </form>

      {# --- Men√∫ din√°mico --- #}
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        {% for it in main_menu %}
          {% if it.children %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="{{ it.url }}" data-bs-toggle="dropdown"
                 {% if it.new %}target="_blank" rel="noopener"{% endif %}>{{ it.title }}</a>

              <ul class="dropdown-menu">
                {% for ch in it.children %}
                  <li>
                    <a class="dropdown-item" href="{{ ch.url }}"
                       {% if ch.open_in_new_tab %}target="_blank" rel="noopener"{% endif %}>
                      {{ ch.title }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ it.url }}"
                 {% if it.new %}target="_blank" rel="noopener"{% endif %}>
                {{ it.title }}
              </a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>

      {# --- Selector de idioma --- #}
      <select id="lang-switcher"
              class="form-select form-select-sm me-2"
              style="width:auto"
              onchange="window.changeLang && window.changeLang(this.value)">
        <option value="es" {% if request.LANGUAGE_CODE == 'es' %}selected{% endif %}>ES</option>
        <option value="en" {% if request.LANGUAGE_CODE == 'en' %}selected{% endif %}>EN</option>
      </select>

      <!-- Dark mode toggle -->
      <button id="themeToggle"
              class="btn btn-sm btn-outline-secondary ms-3 rounded-pill px-3"
              type="button">
        üåô
      </button>

      {# --- Formulario fall-back Django set_language --- #}
      <form id="lang-fallback-form" action="{% url 'set_language' %}"
            method="post" class="d-none">
        {% csrf_token %}
        <input type="hidden" name="language" value="{{ request.LANGUAGE_CODE }}">
        <input type="hidden" name="next" value="{{ request.get_full_path }}">
      </form>

      {# --- CARRITO alineado con los dem√°s botones --- #}
      <a href="{% url 'core:cart_detail' %}"
         class="btn btn-outline-primary d-flex align-items-center gap-2 position-relative me-2">
        <span class="bi bi-bag"></span>
        <span>{% trans 'Carrito' %}</span>

        {% if cart_count %}
          <span class="badge bg-primary text-white position-absolute"
                style="top:-6px; right:-6px; font-size:0.65rem;">
            {{ cart_count }}
          </span>
        {% endif %}
      </a>



      {% if request.user.is_authenticated %}
        <a class="btn btn-primary" href="{% url 'core:logout' %}">Cerrar sesi√≥n</a>
      {% else %}
      <li class="nav-item">
        <a class="btn btn-primary" href="{% url 'core:login' %}">Ingresar</a>
      </li>
      <li class="nav-item">
        <a class="btn btn-outline-light btn-sm" href="{% url 'core:register' %}">
          Crear cuenta
        </a>
      </li>
      {% endif %}


    </div>
  </div>
</nav>
