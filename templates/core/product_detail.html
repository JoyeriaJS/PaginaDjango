{% extends "base_site.html" %}
{% block title %}{{ product.name }} â€” ArtesanÃ­as Pachy{% endblock %}

{% block content %}

<div class="container py-4" itemscope itemtype="https://schema.org/Product">

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb small">
      <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Inicio</a></li>
      <li class="breadcrumb-item">
        <a href="{% url 'core:category_list' product.category.pk %}" class="text-decoration-none">
          {{ product.category.name }}
        </a>
      </li>
      <li class="breadcrumb-item active text-muted" aria-current="page">{{ product.name }}</li>
    </ol>
  </nav>

  <div class="row g-5">

    <!-- ======================== -->
    <!-- GALERÃA (estilo Promano) -->
    <!-- ======================== -->
    <div class="col-12 col-lg-6">

      <div class="card p-3 gallery-elev border-0 shadow-sm">

        {% with first=product.images.first %}
          <div id="pd-main"
               class="ratio ratio-1x1 rounded-4 overflow-hidden pointer border"
               {% if first %}data-zoom="{{ first.image.url }}"{% endif %}>

            {% if first %}
              <img src="{{ first.image.url }}"
                   alt="{{ first.alt|default:product.name }}"
                   class="w-100 h-100"
                   style="object-fit:cover;"
                   itemprop="image">
            {% else %}
              <div class="d-flex align-items-center justify-content-center text-muted">
                Sin imagen
              </div>
            {% endif %}
          </div>
        {% endwith %}

        <!-- Thumbnails -->
        <div class="d-flex gap-2 mt-3 flex-wrap">
          {% for im in product.images.all %}
            <button type="button"
                    class="thumb-64 btn p-0 border rounded-3 overflow-hidden shadow-sm"
                    data-target="#pd-main"
                    data-src="{{ im.image.url }}">
              <img src="{{ im.image.url }}"
                   class="w-100 h-100"
                   style="object-fit:cover;"
                   alt="{{ im.alt|default:product.name }}">
            </button>
          {% empty %}
            <div class="text-muted small">Sin imÃ¡genes adicionales</div>
          {% endfor %}
        </div>

      </div>

    </div>

    <!-- ======================== -->
    <!-- INFORMACIÃ“N DEL PRODUCTO -->
    <!-- ======================== -->
    <div class="col-12 col-lg-6">

      <!-- TÃ­tulo + badge -->
      <div class="d-flex justify-content-between align-items-start">
        <h1 class="h3 fw-bold mb-2" itemprop="name" style="letter-spacing:-.3px;">
          {{ product.name }}
        </h1>

        {% if product.is_new %}
          <span class="badge bg-primary-subtle text-primary border rounded-pill px-3">
            Nuevo
          </span>
        {% endif %}
      </div>

      <!-- Datos de confianza (BlueCast vibes) -->
      <div class="mt-2 small text-muted d-flex flex-column gap-1">
        <div>ðŸ”’ Pago seguro con tarjetas y transferencias.</div>
        <div>ðŸšš EnvÃ­os a todo Chile (2â€“5 dÃ­as hÃ¡biles).</div>
        <div>ðŸ”„ Cambios dentro de 10 dÃ­as.</div>
      </div>

      <!-- Material -->
      {% if product.material %}
        <div class="text-muted small mt-3">
          <strong>Material:</strong> {{ product.material.name }}
        </div>
      {% endif %}

      <!-- Precio -->
      <div class="mt-3 h3 fw-bold" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
        <meta itemprop="priceCurrency" content="CLP">
        <span itemprop="price">${{ product.price }}</span>

        {% if product.stock is not None %}
          <div class="small mt-1 
            {% if product.stock > 3 %}text-success
            {% elif product.stock > 0 %}text-warning
            {% else %}text-danger{% endif %}">
            {% if product.stock > 3 %}
              Disponible
            {% elif product.stock > 0 %}
              Â¡Pocas unidades!
            {% else %}
              Agotado
            {% endif %}
          </div>
        {% endif %}
      </div>

      <!-- DescripciÃ³n -->
      {% if product.description %}
        <p class="mt-3 text-muted" itemprop="description" style="line-height:1.6;">
          {{ product.description }}
        </p>
      {% endif %}


      <!-- ======================== -->
      <!-- CTA â€” Agregar al carrito -->
      <!-- ======================== -->

      {% if product.stock is not None and product.stock|default:0 <= 0 %}
        <div class="mt-4">
          <button class="btn btn-secondary btn-lg w-100 rounded-pill" disabled>
            Agotado
          </button>
        </div>
      {% else %}
        <form method="post"
              action="{% url 'core:add_to_cart' product.pk %}"
              class="mt-4 sticky-cta">
          {% csrf_token %}

          <div class="d-flex gap-3 align-items-center">
            <input class="form-control"
                   type="number"
                   name="qty"
                   value="1"
                   min="1"
                   style="max-width:110px;">

            <button class="btn btn-primary btn-lg rounded-pill flex-grow-1 px-4">
              Agregar al carrito
            </button>
          </div>

        </form>
      {% endif %}


      <!-- Etiquetas -->
      {% if product.tags %}
        <div class="d-flex flex-wrap gap-2 mt-4">
          {% for t in product.tags.all %}
            <span class="badge rounded-pill bg-light text-muted border">
              {{ t.name }}
            </span>
          {% endfor %}
        </div>
      {% endif %}

    </div>
  </div>


  <!-- ======================== -->
  <!-- PRODUCTOS RELACIONADOS -->
  <!-- ======================== -->
  {% if related %}
    <section class="mt-5 pt-4">

      <div class="d-flex justify-content-between align-items-end mb-3">
        <h2 class="h5 fw-bold m-0">TambiÃ©n te puede interesar</h2>
        <a class="small text-decoration-none"
           href="{% url 'core:category_list' product.category.pk %}">
          Ver mÃ¡s â†’
        </a>
      </div>

      <div class="row g-4">
        {% for p in related %}
        <div class="col-6 col-md-3">

          <a class="card text-decoration-none card-elev h-100 border-0 shadow-sm"
             href="{% url 'core:product_detail' p.pk %}">

            <div class="thumb-1x1 rounded-top overflow-hidden">
              {% with img=p.images.first %}
                {% if img %}
                  <img src="{{ img.image.url }}" alt="{{ p.name }}">
                {% else %}
                  <div class="bg-light d-flex align-items-center justify-content-center text-muted">
                    Sin imagen
                  </div>
                {% endif %}
              {% endwith %}
            </div>

            <div class="card-body">
              <div class="small text-muted">{{ p.category.name }}</div>
              <div class="fw-semibold text-dark">{{ p.name }}</div>
              <div class="fw-bold mt-1">${{ p.price }}</div>
            </div>

          </a>

        </div>
        {% endfor %}
      </div>

    </section>
  {% endif %}


</div>


<!-- ======================== -->
<!-- MODAL ZOOM -->
<!-- ======================== -->
<div class="modal fade" id="imgZoomModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-dark border-0">
      <div class="modal-body p-0">
        <img id="imgZoomTarget" class="w-100" alt="Zoom">
      </div>
      <button type="button"
              class="btn btn-light position-absolute top-0 end-0 m-2"
              data-bs-dismiss="modal">
        Cerrar
      </button>
    </div>
  </div>
</div>

{% endblock %}


{% block extra_js %}
{{ block.super }}

<script>
  (function(){
    // Cambiar imagen principal al hacer click en miniaturas
    document.addEventListener('click', function(e){
      const btn = e.target.closest('button[data-target][data-src]');
      if (!btn) return;

      const targetSel = btn.getAttribute('data-target');
      const src = btn.getAttribute('data-src');
      const main = document.querySelector(targetSel);
      if (!main) return;

      const img = main.querySelector('img');
      if (img) img.src = src;
      main.setAttribute('data-zoom', src);
    });

    // Abrir modal de zoom al click en imagen principal
    const pdMain = document.getElementById('pd-main');
    if (pdMain) {
      pdMain.addEventListener('click', function(){
        const zoomSrc = pdMain.getAttribute('data-zoom');
        if (!zoomSrc) return;

        const img = document.getElementById('imgZoomTarget');
        img.src = zoomSrc;

        new bootstrap.Modal(document.getElementById('imgZoomModal')).show();
      });
    }
  })();
</script>

{% endblock %}
