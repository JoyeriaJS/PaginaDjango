{% extends "base_site.html" %}
{% block title %}Carrito â€” ArtesanÃ­as Pachy{% endblock %}

{% block content %}
<div class="container py-5">

  <h1 class="h4 fw-bold mb-4">Tu carrito</h1>

  {% if cart.items %}
  
  <!-- ============================================= -->
  <!-- TABLA DE CARRITO -->
  <!-- ============================================= -->
  <form method="post" action="{% url 'core:update_cart' %}">
    {% csrf_token %}

    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="text-muted small">
          <tr>
            <th style="width:90px;"></th>
            <th>Producto</th>
            <th class="text-center" style="width:120px;">Cantidad</th>
            <th class="text-end" style="width:150px;">Total</th>
            <th></th>
          </tr>
        </thead>
        
        <tbody>

          {% for line in cart.items %}
          <tr>

            <!-- Imagen -->
            <td>
              {% if line.product.images.first %}
              <img src="{{ line.product.images.first.image.url }}"
                   class="rounded"
                   style="width:75px;height:75px;object-fit:cover;">
              {% else %}
              <div class="ratio ratio-1x1 bg-light rounded"
                   style="width:75px;"></div>
              {% endif %}
            </td>

            <!-- Nombre -->
            <td>
              <a href="{% url 'core:product_detail' line.product.pk %}"
                 class="text-dark fw-semibold text-decoration-none">
                {{ line.product.name }}
              </a>
              <div class="small text-muted">
                {{ line.product.category.name }}
              </div>
            </td>

            <!-- Cantidad -->
            <td class="text-center">
              <input type="number"
                     name="qty_{{ line.id }}"
                     value="{{ line.qty }}"
                     min="1"
                     class="form-control form-control-sm text-center"
                     style="width:70px;display:inline-block;">
            </td>

            <!-- Total lÃ­nea -->
            <td class="text-end">
              <span data-line-total="{{ line.id }}">
                ${{ line.line_total }}
              </span>
            </td>

            <!-- Eliminar -->
            <td class="text-end">
              <button type="submit"
                      formmethod="post"
                      formaction="{% url 'core:remove_from_cart' line.id %}"
                      class="btn btn-sm btn-light border">
                âœ•
              </button>
            </td>

          </tr>
          {% endfor %}

        </tbody>

      </table>
    </div>

    <!-- ============================================= -->
    <!-- BOTONES INFERIORES -->
    <!-- ============================================= -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mt-4 gap-3">

      <!-- Vaciar carrito -->
      <form method="post" action="{% url 'core:clear_cart' %}">
        {% csrf_token %}
        <button class="btn btn-outline-secondary">
          Vaciar carrito
        </button>
      </form>

      <!-- Totales -->
      <div class="text-end">

        <div class="fw-semibold small text-muted">Subtotal</div>
        <div class="h5 fw-bold mb-2" id="cart-subtotal">
          ${{ cart.subtotal }}
        </div>

        <div class="fw-semibold small text-muted">Total</div>
        <div class="h4 fw-bold mb-3" id="cart-grandtotal">
          ${{ cart.grand_total }}
        </div>

        <a class="btn btn-primary btn-lg rounded-pill px-5"
           href="{% url 'core:checkout' %}">
          Ir al pago
        </a>
      </div>

    </div>

  </form>


  {% else %}

  <!-- ============================================= -->
  <!-- CARRITO VACÃO -->
  <!-- ============================================= -->
  <div class="text-center py-5">
    <div class="display-6 mb-3">ðŸ›’</div>
    <h2 class="h5 fw-bold mb-3">Tu carrito estÃ¡ vacÃ­o</h2>
    <p class="text-muted mb-4">
      Cuando agregues productos aparecerÃ¡n aquÃ­.
    </p>
    <a href="/" class="btn btn-primary rounded-pill px-4">
      Ver productos
    </a>
  </div>

  {% endif %}

</div>
{% endblock %}
