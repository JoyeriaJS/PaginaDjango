{% extends "base_site.html" %}
{% block title %}Carrito — Artesanías Pachy{% endblock %}

{% block content %}

<div class="container py-4">

  <h1 class="h3 fw-bold mb-4">Carrito</h1>

  {% if items %}

    <!-- =============================== -->
    <!-- FORM 1: TABLA DEL CARRITO -->
    <!-- =============================== -->
    <form method="post" action="{% url 'core:update_cart' %}">
      {% csrf_token %}

      <div class="table-responsive">
        <table class="table align-middle bg-white shadow-sm rounded-4 overflow-hidden">
          <thead class="table-light">
            <tr>
              <th style="width:80px;">Imagen</th>
              <th>Producto</th>
              <th style="width:140px;">Cantidad</th>
              <th style="width:120px;">Precio</th>
              <th style="width:120px;">Total</th>
              <th style="width:110px;"></th>
            </tr>
          </thead>

          <tbody>
          {% for it in items %}
            <tr>

              <!-- Imagen -->
              <td>
                {% if it.image_url %}
                  <img src="{{ it.image_url }}" class="rounded" style="width:60px;height:60px;object-fit:cover;">
                {% else %}
                  <div class="bg-light text-muted d-flex align-items-center justify-content-center rounded"
                       style="width:60px;height:60px;">–</div>
                {% endif %}
              </td>

              <!-- Nombre -->
              <td>
                <a href="{% url 'core:product_detail' it.id %}"
                   class="fw-semibold text-decoration-none text-dark">
                  {{ it.name }}
                </a>
                {% if it.category %}
                  <div class="small text-muted">{{ it.category }}</div>
                {% endif %}
              </td>

              <!-- Cantidad -->
              <td>
                <input type="number"
                       name="qty_{{ it.id }}"
                       value="{{ it.qty }}"
                       min="1"
                       class="form-control text-center rounded-pill">
              </td>

              <!-- Precio -->
              <td class="fw-semibold">${{ it.price }}</td>

              <!-- Total línea -->
              <td class="fw-bold">
                <span data-line-total="{{ it.id }}">${{ it.total }}</span>
              </td>

              <!-- Botón quitar -->
              <td class="text-end">
                <form method="post"
                      action="{% url 'core:remove_from_cart' it.id %}"
                      class="d-inline">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger rounded-pill px-3">Quitar</button>
                </form>
              </td>

            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Botón actualizar -->
      <div class="d-flex justify-content-end mt-3">
        <button class="btn btn-primary rounded-pill px-4">Actualizar</button>
      </div>
    </form>



    <!-- =============================== -->
    <!-- ACCIONES + RESUMEN -->
    <!-- =============================== -->

    <div class="row mt-4 g-4">

      <!-- CONTROLES -->
      <div class="col-12 col-lg-6">

        <!-- Vaciar carrito -->
        <form method="post" action="{% url 'core:clear_cart' %}" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-outline-danger rounded-pill px-4">
            Vaciar carrito
          </button>
        </form>

        <a href="/" class="btn btn-outline-secondary rounded-pill px-4 ms-2">
          Seguir comprando
        </a>
      </div>


      <!-- RESUMEN DE PAGO -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm border-0 rounded-4 p-4">

          <h5 class="fw-bold mb-3">Resumen</h5>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Subtotal</span>
            <strong id="cart-subtotal">${{ subtotal }}</strong>
          </div>

          <!-- Cupón -->
          <form class="mt-3 d-flex gap-2" method="post" action="{% url 'core:apply_coupon' %}">
            {% csrf_token %}

            {% if discount_code %}
              <input class="form-control rounded-pill" value="{{ discount_code }}" disabled>
              <button formaction="{% url 'core:remove_coupon' %}"
                      class="btn btn-outline-danger rounded-pill px-3">
                Quitar
              </button>
            {% else %}
              <input name="coupon"
                     class="form-control rounded-pill"
                     placeholder="Código de descuento">
              <button class="btn btn-outline-primary rounded-pill px-4">Aplicar</button>
            {% endif %}
          </form>

          {% if discount_amount and discount_amount > 0 %}
            <div class="d-flex justify-content-between text-success mt-3">
              <span>Descuento</span>
              <strong>- ${{ discount_amount }}</strong>
            </div>
          {% endif %}

          <hr>

          <!-- TOTAL -->
          <div class="d-flex justify-content-between fs-5 fw-bold mb-3">
            <span>Total</span>
            <span id="cart-grandtotal">${{ grand_total }}</span>
          </div>

          <!-- Botón pagar -->
          <a class="btn btn-success w-100 rounded-pill py-2 fs-6"
             href="{% url 'core:checkout' %}">
            Ir a pagar
          </a>

          <div class="text-muted small mt-3">
            Al pagar aceptas nuestros
            <a href="/terminos/" class="text-decoration-none">Términos</a> y
            <a href="/cambios-devoluciones/" class="text-decoration-none">Política de Cambios</a>.
          </div>

        </div>
      </div>

    </div>



  {% else %}
    <!-- Carrito vacío -->
    <div class="alert alert-info shadow-sm rounded-4">Tu carrito está vacío.</div>
    <a href="/" class="btn btn-primary btn-lg rounded-pill px-4">Ir a comprar</a>
  {% endif %}

</div>

{% endblock %}
