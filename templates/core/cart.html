{% extends "base_site.html" %}
{% block title %}Carrito — Artesanías Pachy{% endblock %}
{% block content %}
<div class="container py-4">
  <h1 class="h3 mb-3">Carrito</h1>

  {% if items %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th style="width:80px">Img</th>
            <th>Producto</th>
            <th style="width:140px">Cantidad</th>
            <th style="width:120px">Precio</th>
            <th style="width:120px">Total</th>
            <th style="width:110px"></th>
          </tr>
        </thead>
        <tbody>
        {% for it in items %}
          <tr>
            <td>
              {% if it.image_url %}
                <img src="{{ it.image_url }}" class="img-thumbnail" style="width:60px;height:60px;object-fit:cover;">
              {% else %}
                <div class="bg-light text-muted d-flex align-items-center justify-content-center"
                     style="width:60px;height:60px;border:1px solid #e5e5e5;border-radius:.25rem;">–</div>
              {% endif %}
            </td>
            <td>
              <a href="{% url 'core:product_detail' it.id %}" class="text-decoration-none">{{ it.name }}</a>
              {% if it.category %}
                <div class="small text-muted">{{ it.category }}</div>
              {% endif %}
            </td>

            <td>
              <input type="number"
                     class="form-control qty-input"
                     value="{{ it.qty }}"
                     min="1"
                     data-product="{{ it.id }}">
            </td>

            <td>${{ it.price }}</td>

            <td>
              <span id="line-total-{{ it.id }}" class="fw-bold">
                ${{ it.total }}
              </span>
            </td>

            <td class="text-end">
              <form method="post" action="{% url 'core:remove_from_cart' it.id %}" class="d-inline">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger">Quitar</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="row mt-3">
      <div class="col-12 col-lg-6">
        <form method="post" action="{% url 'core:clear_cart' %}" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-outline-danger">Vaciar carrito</button>
        </form>
        <a href="/" class="btn btn-outline-secondary ms-2">Seguir comprando</a>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card p-3 mt-3 mt-lg-0" style="min-width:320px">

          <!-- SUBTOTAL -->
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal</span>
            <strong id="cart-subtotal">${{ subtotal }}</strong>
          </div>

          <!-- ============================ -->
          <!-- FORMULARIO DE CUPÓN -->
          <!-- ============================ -->
          <form method="post" action="{% url 'core:apply_coupon' %}" class="mb-2">
            {% csrf_token %}
            <label class="form-label small">Código de descuento</label>

            <div class="input-group">
              <input type="text"
                     name="coupon"
                     class="form-control"
                     placeholder="Ingresa tu cupón"
                     value="{{ discount_code|default:'' }}">
              <button class="btn btn-primary" type="submit">Aplicar</button>
            </div>

            {% if discount_code %}
              <div class="d-flex justify-content-between mt-2">
                <span class="text-success small">Cupón aplicado: <strong>{{ discount_code }}</strong></span>
                <form method="post" action="{% url 'core:remove_coupon' %}">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger">Quitar</button>
                </form>
              </div>
            {% endif %}
          </form>

          {% if discount_amount > 0 %}
            <div class="d-flex justify-content-between text-success">
              <span>Descuento</span>
              <strong>- ${{ discount_amount }}</strong>
            </div>
          {% endif %}

          <hr class="my-2">

          <div class="d-flex justify-content-between fs-5">
            <span>Total</span>
            <strong id="cart-grandtotal">${{ grand_total }}</strong>
          </div>

          <a class="btn btn-success w-100 mt-3" href="{% url 'core:checkout' %}">
            Ir a pagar
          </a>

        </div>
      </div>
    </div>

  {% else %}
    <div class="alert alert-info">Tu carrito está vacío.</div>
    <a href="/" class="btn btn-primary">Ir a comprar</a>
  {% endif %}
</div>

<!-- ============================
     ACTUALIZACIÓN DINÁMICA
================================ -->
<script>
document.querySelectorAll(".qty-input").forEach(input => {
    input.addEventListener("change", function () {

        const pid = this.dataset.product;
        const qty = this.value;

        const formData = new FormData();
        formData.append(`qty_${pid}`, qty);

        fetch("{% url 'core:update_cart' %}", {
            method: "POST",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: formData
        })
        .then(r => r.json())
        .then(data => {

            if (!data.ok) return;

            data.lines.forEach(line => {
                const el = document.getElementById("line-total-" + line.id);
                if (el) {
                    el.textContent = "$" + line.line_total;
                    el.style.background = "#d1ffd1";
                    setTimeout(() => el.style.background = "transparent", 600);
                }
            });

            if (data.grand_total) {
                document.getElementById("cart-grandtotal").textContent = "$" + data.grand_total;
            }

            if (data.subtotal) {
                document.getElementById("cart-subtotal").textContent = "$" + data.subtotal;
            }

            if (data.empty) {
                location.reload();
            }
        });
    });
});
</script>
{% endblock %}
