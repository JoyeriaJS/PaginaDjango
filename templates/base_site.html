{% load static %}
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Artesanías Pachy{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}Joyería y artesanías en lapislázuli hechas en Chile.{% endblock %}">
    <meta property="og:title" content="{% block og_title %}Artesanías Pachy{% endblock %}">
    <meta property="og:description" content="{% block og_desc %}Joyería y artesanías en lapislázuli hechas en Chile.{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <link rel="icon" href="{% static 'img/favicon.ico' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'css/site.css' %}" rel="stylesheet">
    {% block extra_head %}{% endblock %}
  </head>
  <body>
    {% include "includes/navbar.html" %}

    {# --- MENSAJES FLASH (éxito, error, info) --- #}
    {% if messages %}
      <div class="container mt-3">
        {% for m in messages %}
          <div class="alert alert-{{ m.tags|default:'info' }} mb-2" role="alert">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <main>{% block content %}{% endblock %}</main>

    {% include "includes/footer.html" %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% block extra_js %}{% endblock %}

    {# --- BOTÓN FLOTANTE DE CARRITO (usa cart_count del context processor) --- #}
    <a href="{% url 'core:cart_detail' %}"
       class="btn btn-primary position-fixed d-flex align-items-center gap-2"
       style="right: 16px; bottom: 16px; z-index: 1040;">
      <span class="bi bi-bag"></span>
      <span>Carrito</span>
      {% if cart_count %}
        <span class="badge bg-light text-primary">{{ cart_count }}</span>
      {% endif %}
    </a>



  <script>
(function(){
  // CSRF para fetch POST
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  }
  const csrftoken = getCookie('csrftoken');

  // Actualiza badge carrito si existe
  function setCartBadge(count){
    const btn = document.querySelector('a[href$="/carrito/"].btn') || document.querySelector('a[href*="core:cart_detail"]');
    const badge = document.querySelector('.position-fixed .badge, .btn .badge');
    if (badge) badge.textContent = count > 0 ? count : '';
  }

  // Interceptar formularios de "Agregar al carrito" (detalle)
  document.addEventListener('submit', async (e) => {
    const f = e.target;
    if (f.action && f.action.includes('/carrito/agregar/')) {
      e.preventDefault();
      const formData = new FormData(f);
      const res = await fetch(f.action, {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken},
        body: formData
      });
      const data = await res.json();
      if (data.ok) {
        setCartBadge(parseInt(data.cart_count || 0));
        // mini feedback
        try {
          const div = document.createElement('div');
          div.className = 'toast align-items-center text-bg-success border-0 show';
          div.style.position = 'fixed'; div.style.right = '16px'; div.style.bottom = '80px'; div.style.zIndex = '1050';
          div.innerHTML = `<div class="d-flex"><div class="toast-body">${data.message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto"></button></div>`;
          document.body.appendChild(div);
          div.querySelector('.btn-close').onclick = ()=>div.remove();
          setTimeout(()=>div.remove(), 2000);
        } catch(_) {}
      }
    }
  });

  // En página del carrito: auto-actualizar al cambiar cantidades
  function onCartPage(){
    return window.location.pathname.endsWith('/carrito/');
  }

  async function postCart(url, payload){
    const res = await fetch(url, {
      method: 'POST',
      headers: {'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': csrftoken},
      body: new URLSearchParams(payload)
    });
    return res.json();
  }

  if (onCartPage()){
    const form = document.querySelector('form[action$="/carrito/actualizar/"]');
    const totals = {
      subtotal: document.querySelector('#cart-subtotal'),
      grand: document.querySelector('#cart-grandtotal')
    };

    // Cambios de cantidad -> debounce + update_cart
    let t;
    document.addEventListener('input', (e) => {
      if (!form || !(e.target.name||'').startsWith('qty_')) return;
      clearTimeout(t);
      t = setTimeout(async () => {
        const payload = {};
        new FormData(form).forEach((v,k)=>payload[k]=v);
        const data = await postCart(form.action, payload);
        if (data.ok){
          setCartBadge(parseInt(data.cart_count||0));
          if (totals.subtotal) totals.subtotal.textContent = '$'+data.subtotal;
          if (totals.grand) totals.grand.textContent = '$'+data.grand_total;
          // actualizar totales por línea si existen spans data-line-total
          (data.lines||[]).forEach(line=>{
            const span = document.querySelector(`[data-line-total="${line.id}"]`);
            if (span) span.textContent = '$'+line.line_total;
          });
          if (data.empty) window.location.reload();
        }
      }, 350);
    });

    // Botones Quitar (formaction) por AJAX
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[formaction][formmethod="post"]');
      if (!btn || !btn.getAttribute('formaction').includes('/carrito/quitar/')) return;
      e.preventDefault();
      const url = btn.getAttribute('formaction');
      const row = btn.closest('tr');
      const data = await postCart(url, {});
      if (data.ok){
        row?.remove();
        setCartBadge(parseInt(data.cart_count||0));
        if (totals.subtotal) totals.subtotal.textContent = '$'+data.subtotal;
        if (totals.grand) totals.grand.textContent = '$'+data.grand_total;
        if (data.empty) window.location.reload();
      }
    });

    // Vaciar carrito
    const clearForm = document.querySelector('form[action$="/carrito/vaciar/"]');
    if (clearForm){
      clearForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = await postCart(clearForm.action, {});
        if (data.ok){ setCartBadge(0); window.location.reload(); }
      });
    }
  }
})();
</script>

  </body>
  
</html>
