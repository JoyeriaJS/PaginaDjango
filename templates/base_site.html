{% load static %}
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Artesan칤as Pachy{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}Joyer칤a y artesan칤as en lapisl치zuli hechas en Chile.{% endblock %}">
    <meta property="og:title" content="{% block og_title %}Artesan칤as Pachy{% endblock %}">
    <meta property="og:description" content="{% block og_desc %}Joyer칤a y artesan칤as en lapisl치zuli hechas en Chile.{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <link rel="icon" href="{% static 'img/favicon.ico' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'css/site.css' %}" rel="stylesheet">
    {% block extra_head %}
      <!-- AOS (scroll animations) -->
      <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
      <!-- Swiper (hero / logos / testimonios) -->
      <link href="https://unpkg.com/swiper@9/swiper-bundle.min.css" rel="stylesheet">
    {% endblock %}
  </head>
  <body>
    {% include "includes/navbar.html" %}

    {# --- MENSAJES FLASH (칠xito, error, info) --- #}
    {% if messages %}
      <div class="container mt-3">
        {% for m in messages %}
          <div class="alert alert-{{ m.tags|default:'info' }} mb-2" role="alert">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <main>{% block content %}{% endblock %}</main>

    {% include "includes/footer.html" %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% block extra_js %}
      <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
      <script src="https://unpkg.com/swiper@9/swiper-bundle.min.js"></script>
      <script>
        AOS.init({ once: true, duration: 700, offset: 80 });

        // INICIALIZACIONES SWIPER (Hero, Testimonios, Marcas)
        window.addEventListener('load', () => {
          // Hero (si existe .hero-swiper)
          const heroEl = document.querySelector('.hero-swiper');
          if (heroEl) {
            new Swiper('.hero-swiper', {
              loop: true,
              autoplay: { delay: 4000 },
              pagination: { el: '.swiper-pagination', clickable: true },
              effect: 'fade',
            });
          }

          // Testimonios (si existe .testimonials-swiper)
          const testEl = document.querySelector('.testimonials-swiper');
          if (testEl) {
            new Swiper('.testimonials-swiper', {
              loop: true,
              autoplay: { delay: 5500 },
              pagination: { el: '.testimonials-swiper .swiper-pagination', clickable: true },
              slidesPerView: 1,
              spaceBetween: 16,
              breakpoints: { 768: { slidesPerView: 2 }, 1200: { slidesPerView: 3 } }
            });
          }

          // Marcas / logos (si existe .brands-swiper)
          const bEl = document.querySelector('.brands-swiper');
          if (bEl) {
            new Swiper('.brands-swiper', {
              loop: true,
              autoplay: { delay: 2500 },
              slidesPerView: 2,
              spaceBetween: 30,
              breakpoints: { 576:{slidesPerView:3}, 768:{slidesPerView:4}, 1200:{slidesPerView:6} }
            });
          }
        });
      </script>
    {% endblock %}

    {# --- BOT칍N FLOTANTE DE CARRITO (usa cart_count del context processor) --- #}
    <a href="{% url 'core:cart_detail' %}"
       class="btn btn-primary position-fixed d-flex align-items-center gap-2"
       style="right: 16px; bottom: 16px; z-index: 1040;">
      <span class="bi bi-bag"></span>
      <span>Carrito</span>
      {% if cart_count %}
        <span class="badge bg-light text-primary">{{ cart_count }}</span>
      {% endif %}
    </a>

    <script>
    (function(){
      // CSRF para fetch POST
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      }
      const csrftoken = getCookie('csrftoken');

      // Actualiza badge carrito si existe
      function setCartBadge(count){
        const badge = document.querySelector('.position-fixed .badge, .btn .badge');
        if (badge) badge.textContent = count > 0 ? count : '';
      }

      // Interceptar formularios de "Agregar al carrito" (detalle)
      document.addEventListener('submit', async (e) => {
        const f = e.target;
        if (f.action && f.action.includes('/carrito/agregar/')) {
          e.preventDefault();
          const formData = new FormData(f);
          const res = await fetch(f.action, {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken},
            body: formData
          });
          const data = await res.json();
          if (data.ok) {
            setCartBadge(parseInt(data.cart_count || 0));
            // mini feedback
            try {
              const div = document.createElement('div');
              div.className = 'toast align-items-center text-bg-success border-0 show';
              div.style.position = 'fixed'; div.style.right = '16px'; div.style.bottom = '80px'; div.style.zIndex = '1050';
              div.innerHTML = `<div class="d-flex"><div class="toast-body">${data.message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto"></button></div>`;
              document.body.appendChild(div);
              div.querySelector('.btn-close').onclick = ()=>div.remove();
              setTimeout(()=>div.remove(), 2000);
            } catch(_) {}
          }
        }
      });

      // En p치gina del carrito: auto-actualizar al cambiar cantidades
      function onCartPage(){
        return window.location.pathname.endsWith('/carrito/');
      }

      async function postCart(url, payload){
        const res = await fetch(url, {
          method: 'POST',
          headers: {'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': csrftoken},
          body: new URLSearchParams(payload)
        });
        return res.json();
      }

      if (onCartPage()){
        const form = document.querySelector('form[action$="/carrito/actualizar/"]');
        const totals = {
          subtotal: document.querySelector('#cart-subtotal'),
          grand: document.querySelector('#cart-grandtotal')
        };

        // Cambios de cantidad -> debounce + update_cart
        let t;
        document.addEventListener('input', (e) => {
          if (!form || !(e.target.name||'').startsWith('qty_')) return;
          clearTimeout(t);
          t = setTimeout(async () => {
            const payload = {};
            new FormData(form).forEach((v,k)=>payload[k]=v);
            const data = await postCart(form.action, payload);
            if (data.ok){
              setCartBadge(parseInt(data.cart_count||0));
              if (totals.subtotal) totals.subtotal.textContent = '$'+data.subtotal;
              if (totals.grand) totals.grand.textContent = '$'+data.grand_total;
              (data.lines||[]).forEach(line=>{
                const span = document.querySelector(`[data-line-total="${line.id}"]`);
                if (span) span.textContent = '$'+line.line_total;
              });
              if (data.empty) window.location.reload();
            }
          }, 350);
        });

        // Botones Quitar (formaction) por AJAX
        document.addEventListener('click', async (e)=>{
          const btn = e.target.closest('button[formaction][formmethod="post"]');
          if (!btn || !btn.getAttribute('formaction').includes('/carrito/quitar/')) return;
          e.preventDefault();
          const url = btn.getAttribute('formaction');
          const row = btn.closest('tr');
          const data = await postCart(url, {});
          if (data.ok){
            row?.remove();
            setCartBadge(parseInt(data.cart_count||0));
            if (totals.subtotal) totals.subtotal.textContent = '$'+data.subtotal;
            if (totals.grand) totals.grand.textContent = '$'+data.grand_total;
            if (data.empty) window.location.reload();
          }
        });

        // Vaciar carrito
        const clearForm = document.querySelector('form[action$="/carrito/vaciar/"]');
        if (clearForm){
          clearForm.addEventListener('submit', async (e)=>{
            e.preventDefault();
            const data = await postCart(clearForm.action, {});
            if (data.ok){ setCartBadge(0); window.location.reload(); }
          });
        }
      }
    })();
    </script>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
      <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body" id="toast-msg">Acci칩n realizada</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>
    <script>
      window.showToast = function (msg) {
        const el = document.getElementById('liveToast');
        document.getElementById('toast-msg').textContent = msg || 'Acci칩n realizada';
        const t = new bootstrap.Toast(el);
        t.show();
      }
    </script>

    <a href="https://wa.me/56912345678" target="_blank" rel="noopener"
       class="btn btn-success rounded-circle shadow-lg position-fixed"
       style="right:16px; bottom:16px; width:56px; height:56px; display:grid; place-items:center; z-index:1050;">
      <span style="font-size:22px; line-height:1;">游눫</span>
    </a>

    <script>
  // Mini gallery: click en thumbnails cambia la principal
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button.thumb-64[data-src]');
    if (!btn) return;
    const targetSel = btn.getAttribute('data-target');
    const src = btn.getAttribute('data-src');
    const cont = document.querySelector(targetSel);
    if (!cont) return;
    const img = cont.querySelector('img');
    if (img) img.src = src;
    cont.setAttribute('data-zoom', src);
  });

  // Zoom modal
  document.addEventListener('click', (e)=>{
    const box = e.target.closest('#pd-main');
    if (!box) return;
    const src = box.getAttribute('data-zoom');
    const modalImg = document.getElementById('imgZoomTarget');
    if (!src || !modalImg) return;
    modalImg.src = src;
    const modal = new bootstrap.Modal(document.getElementById('imgZoomModal'));
    modal.show();
  });
</script>
  <script>
  // Inicializa Google Translate
  function googleTranslateElementInit() {
    new google.translate.TranslateElement({
      pageLanguage: 'es',
      includedLanguages: 'en,es',
      autoDisplay: false
    }, 'gt-placeholder');
  }
</script>
<div id="gt-placeholder" style="display:none"></div>
<script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script>
  // Helper para forzar traducci칩n v칤a cookie
  function setGoogleLang(lang) {
    // lang: 'es' o 'en'
    var cookieValue = lang === 'es' ? 'es|es' : 'es|en';
    document.cookie = 'googtrans=/' + cookieValue + ';path=/';
    document.cookie = 'googtrans=/' + cookieValue + ';path=/;domain=' + window.location.hostname.replace(/^www\./,'');
    location.reload();
  }
</script>


  </body>
</html>
