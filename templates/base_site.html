{% load static %}
<!doctype html>
<html lang="{{ request.LANGUAGE_CODE|default:'es' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Artesan칤as Pachy{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}Joyer칤a y artesan칤as en lapisl치zuli hechas en Chile.{% endblock %}">
    <meta property="og:title" content="{% block og_title %}Artesan칤as Pachy{% endblock %}">
    <meta property="og:description" content="{% block og_desc %}Joyer칤a y artesan칤as en lapisl치zuli hechas en Chile.{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">

    <link rel="icon" href="{% static 'img/favicon.ico' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'css/site.css' %}" rel="stylesheet">

    {% block extra_head %}
      <!-- AOS (scroll animations) -->
      <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
      <!-- Swiper (hero / marcas / testimonios) -->
      <link href="https://unpkg.com/swiper@9/swiper-bundle.min.css" rel="stylesheet">
    {% endblock %}
  </head>
  <body>
    {% include "includes/navbar.html" %}

    {# --- MENSAJES FLASH --- #}
    {% if messages %}
      <div class="container mt-3">
        {% for m in messages %}
          <div class="alert alert-{{ m.tags|default:'info' }} mb-2" role="alert">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <main>{% block content %}{% endblock %}</main>

    {% include "includes/footer.html" %}

    <!-- Core JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    {% block extra_js %}
      <!-- Libs de efectos -->
      <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
      <script src="https://unpkg.com/swiper@9/swiper-bundle.min.js"></script>

      <script>
        // AOS una vez
        AOS.init({ once: true, duration: 700, offset: 80 });

        // Swipers condicionales
        window.addEventListener('load', () => {
          // Hero
          if (document.querySelector('.hero-swiper')) {
            new Swiper('.hero-swiper', {
              loop: true,
              autoplay: { delay: 4000 },
              pagination: { el: '.hero-swiper .swiper-pagination', clickable: true },
              effect: 'fade',
            });
          }

          // Testimonios
          if (document.querySelector('.testimonials-swiper')) {
            new Swiper('.testimonials-swiper', {
              loop: true,
              autoplay: { delay: 5500 },
              pagination: { el: '.testimonials-swiper .swiper-pagination', clickable: true },
              slidesPerView: 1,
              spaceBetween: 16,
              breakpoints: { 768: { slidesPerView: 2 }, 1200: { slidesPerView: 3 } }
            });
          }

          // Marcas
          if (document.querySelector('.brands-swiper')) {
            new Swiper('.brands-swiper', {
              loop: true,
              autoplay: { delay: 2500 },
              slidesPerView: 2,
              spaceBetween: 30,
              breakpoints: { 576:{slidesPerView:3}, 768:{slidesPerView:4}, 1200:{slidesPerView:6} }
            });
          }
        });
      </script>
    {% endblock %}



    

    <!-- JS del carrito (AJAX agregar/actualizar/quitar/vaciar) -->
    <script>
      (function(){
        // CSRF
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        }
        const csrftoken = getCookie('csrftoken');

        function setCartBadge(count){
          const badge = document.querySelector('.position-fixed .badge');
          if (!badge) return;
          if (count > 0) { badge.textContent = count; badge.classList.remove('d-none'); }
          else { badge.textContent = ''; }
        }

        // Agregar al carrito (formularios cuyo action contiene /carrito/agregar/)
        document.addEventListener('submit', async (e) => {
          const f = e.target;
          if (!f.action || !f.action.includes('/carrito/agregar/')) return;
          e.preventDefault();
          const formData = new FormData(f);
          const res = await fetch(f.action, {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken},
            body: formData
          });
          try {
            const data = await res.json();
            if (data.ok) {
              setCartBadge(parseInt(data.cart_count || 0));
              // toast
              const div = document.createElement('div');
              div.className = 'toast align-items-center text-bg-success border-0 show';
              div.style.position = 'fixed'; div.style.right = '16px'; div.style.bottom = '80px'; div.style.zIndex = '1050';
              div.innerHTML = `<div class="d-flex"><div class="toast-body">${data.message || 'Agregado al carrito'}</div><button type="button" class="btn-close btn-close-white me-2 m-auto"></button></div>`;
              document.body.appendChild(div);
              div.querySelector('.btn-close').onclick = ()=>div.remove();
              setTimeout(()=>div.remove(), 1800);
            }
          } catch(_) {}
        });

        // Helpers carrito
        function onCartPage(){ return window.location.pathname.endsWith('/carrito/'); }
        async function postCart(url, payload){
          const res = await fetch(url, {
            method: 'POST',
            headers: {'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': csrftoken},
            body: new URLSearchParams(payload || {})
          });
          return res.json();
        }

        if (onCartPage()){
          const form = document.querySelector('form[action$="/carrito/actualizar/"]');
          const totals = {
            subtotal: document.querySelector('#cart-subtotal'),
            grand: document.querySelector('#cart-grandtotal')
          };

          // Auto-actualizar cantidades (debounce)
          let t;
          document.addEventListener('input', (e) => {
            if (!form || !(e.target.name||'').startsWith('qty_')) return;
            clearTimeout(t);
            t = setTimeout(async () => {
              const payload = {};
              new FormData(form).forEach((v,k)=>payload[k]=v);
              const data = await postCart(form.action, payload);
              if (data.ok){
                setCartBadge(parseInt(data.cart_count||0));
                if (totals.subtotal) totals.subtotal.textContent = '$'+data.subtotal;
                if (totals.grand) totals.grand.textContent = '$'+data.grand_total;
                (data.lines||[]).forEach(line=>{
                  const span = document.querySelector(`[data-line-total="${line.id}"]`);
                  if (span) span.textContent = '$'+line.line_total;
                });
                if (data.empty) window.location.reload();
              }
            }, 350);
          });

          // Quitar 칤tem
          document.addEventListener('click', async (e)=>{
            const btn = e.target.closest('button[formaction][formmethod="post"]');
            if (!btn || !btn.getAttribute('formaction').includes('/carrito/quitar/')) return;
            e.preventDefault();
            const url = btn.getAttribute('formaction');
            const row = btn.closest('tr');
            const data = await postCart(url, {});
            if (data.ok){
              row?.remove();
              setCartBadge(parseInt(data.cart_count||0));
              if (totals.subtotal) totals.subtotal.textContent = '$'+data.subtotal;
              if (totals.grand) totals.grand.textContent = '$'+data.grand_total;
              if (data.empty) window.location.reload();
            }
          });

          // Vaciar carrito
          const clearForm = document.querySelector('form[action$="/carrito/vaciar/"]');
          if (clearForm){
            clearForm.addEventListener('submit', async (e)=>{
              e.preventDefault();
              const data = await postCart(clearForm.action, {});
              if (data.ok){ setCartBadge(0); window.location.reload(); }
            });
          }
        }
      })();
    </script>

    <!-- Toast gen칠rico -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
      <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert">
        <div class="d-flex">
          <div class="toast-body" id="toast-msg">Acci칩n realizada</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>
    <script>
      window.showToast = function (msg) {
        const el = document.getElementById('liveToast');
        document.getElementById('toast-msg').textContent = msg || 'Acci칩n realizada';
        const t = new bootstrap.Toast(el);
        t.show();
      }
    </script>

    <!-- WhatsApp flotante -->
    <a href="https://wa.me/56912345678" target="_blank" rel="noopener"
       class="btn btn-success rounded-circle shadow-lg position-fixed"
       style="right:16px; bottom:16px; width:56px; height:56px; display:grid; place-items:center; z-index:1050;">
      <span style="font-size:22px; line-height:1;">游눫</span>
    </a>

    <!-- Mini-galer칤a + Zoom (para product_detail) -->
    <script>
      // Cambiar imagen principal al hacer click en thumbnails
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('button.thumb-64[data-src]');
        if (!btn) return;
        const targetSel = btn.getAttribute('data-target');
        const src = btn.getAttribute('data-src');
        const cont = document.querySelector(targetSel);
        if (!cont) return;
        const img = cont.querySelector('img');
        if (img) img.src = src;
        cont.setAttribute('data-zoom', src);
      });

      // Abrir modal de zoom al clickear la imagen principal
      document.addEventListener('click', (e)=>{
        const box = e.target.closest('#pd-main');
        if (!box) return;
        const src = box.getAttribute('data-zoom');
        const modalImg = document.getElementById('imgZoomTarget');
        if (!src || !modalImg) return;
        modalImg.src = src;
        const modal = new bootstrap.Modal(document.getElementById('imgZoomModal'));
        modal.show();
      });
    </script>

    <!-- Google Translate (perezoso; ES por defecto) -->
          <div id="gt-placeholder" style="display:none"></div>
          <script>
          (function(){
            // --- helpers cookies googtrans ---
            function setLangCookie(lang){
              var v = (lang === 'en') ? 'es|en' : 'es|es';
              // host-only
              document.cookie = 'googtrans=/'+v+'; path=/';
              // domain expl칤cito (incluye quitar www)
              var d1 = location.hostname;
              var d2 = location.hostname.replace(/^www\./,'');
              [d1,d2].forEach(function(d){
                if (!d) return;
                document.cookie = 'googtrans=/'+v+'; path=/; domain='+d;
              });
            }
            function getLangFromCookie(){
              return /(?:^|; )googtrans=\/es\|en(?:;|$)/.test(document.cookie) ? 'en' : 'es';
            }

            // --- carga perezosa del script de Google ---
            var gtLoaded=false, gtLoading=false;
            function loadGT(callback){
              if (gtLoaded){ callback && callback(); return; }
              if (gtLoading){ return; }
              gtLoading = true;
              var s = document.createElement('script');
              s.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
              s.onload = function(){ gtLoaded = true; gtLoading = false; callback && callback(); };
              document.head.appendChild(s);
            }

            // --- inicializaci칩n del widget (Google llamar치 a esta funci칩n) ---
            window.googleTranslateElementInit = function(){
              try{
                new google.translate.TranslateElement({
                  pageLanguage: 'es',
                  includedLanguages: 'en,es',
                  autoDisplay: false
                }, 'gt-placeholder');
              }catch(e){}
            };

            // Aplica el idioma en el combo del widget (cuando ya existe)
            function applyGoogleLang(lang){
              if (typeof google === 'undefined' || !google.translate) return false;
              var tries = 0;
              (function tick(){
                tries++;
                var combo = document.querySelector('.goog-te-combo');
                if (combo){
                  combo.value = (lang === 'en') ? 'en' : '';
                  combo.dispatchEvent(new Event('change'));
                  return;
                }
                if (tries < 40){ setTimeout(tick, 100); } // seguir buscando hasta 4s
              })();
              return true;
            }

            // API para el <select> del navbar
            window.changeLang = function(lang){
              setLangCookie(lang);
              if (lang === 'en'){
                // cargar Google y aplicar traducci칩n
                loadGT(function(){
                  applyGoogleLang('en');
                  // En algunos navegadores ayuda un reload suave
                  setTimeout(function(){ location.reload(); }, 300);
                });
              } else {
                // volver a espa침ol natural (sin traducci칩n)
                location.reload();
              }
            };

            // Estado inicial: si cookie dice EN, cargamos Google y aplicamos
            var initial = getLangFromCookie();
            if (initial === 'en'){
              loadGT(function(){ applyGoogleLang('en'); });
            }
            // sincroniza selector del navbar (si ya est치 en el DOM)
            window.addEventListener('DOMContentLoaded', function(){
              var sel = document.getElementById('lang-switcher');
              if (sel){ sel.value = initial; }
            });
          })();
          </script>


  </body>
</html>
